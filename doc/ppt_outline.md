# 多渠道 AI API 统一转换代理系统

## PPT 演示大纲

---

## 第一部分：项目概述

### 1.1 项目背景与动机

**AI 星球大模型平台现状**：
- 平台模型通过 **OpenRouter** 渠道接入
- OpenRouter 统一提供 OpenAI 格式的 API 接口
- 支持调用 OpenAI、Anthropic、Google、Meta 等多家模型

**多种 AI API 格式并存的现状**：
- OpenAI Chat Completions API (`/v1/chat/completions`)
- Anthropic Claude Messages API (`/v1/messages`)
- Google Gemini GenerateContent API (`/v1beta/models/:generateContent`)

**客户端适配痛点**：
- 不同格式的请求/响应结构差异大
- 切换提供商需要大量代码修改
- 高级功能（流式、工具调用、思考模式）实现方式各异
- Claude Code、Gemini CLI 等官方工具只支持原生 API 格式

**解决方案**：
- 统一入口、透明转换、无缝切换
- 让 Claude Code、Gemini CLI 等工具可直接使用 OpenRouter 渠道的模型

### 1.2 项目定位

```
┌─────────────────────────────────────────────────────────┐
│              多渠道 AI API 统一转换代理                   │
├─────────────────────────────────────────────────────────┤
│  • 支持 OpenAI ↔ Anthropic ↔ Gemini 任意互转            │
│  • 渠道管理 + 格式检测 + 智能路由                         │
│  • 完整流式响应 + 函数调用 + 思考模式支持                  │
└─────────────────────────────────────────────────────────┘
```

---

## 第二部分：核心功能

### 2.1 智能格式转换

**自动格式识别**：

| 请求路径 | 识别格式 |
|---------|---------|
| `/v1/chat/completions` | OpenAI |
| `/v1/messages` | Anthropic |
| `/v1beta/models/:generateContent` | Gemini |

**任意格式互转**：

```
OpenAI ←→ Anthropic ←→ Gemini
   ↑                      ↑
   └──────────────────────┘
         任意互转
```

### 2.2 高级功能支持

| 功能 | 描述 | 支持状态 |
|------|------|---------|
| 流式响应 | SSE 格式完整转换 | ✅ |
| 函数调用 | Tool Calling 跨平台映射 | ✅ |
| 视觉理解 | 图像输入格式统一处理 | ✅ |
| 结构化输出 | JSON Schema 自动适配 | ✅ |
| 思考预算 | reasoning_effort ↔ thinkingBudget 互转 | ✅ |
| 模型映射 | 客户端模型名 → 后端实际模型 | ✅ |

### 2.3 全面能力检测

- 自动测试 API 端点的各项能力
- 支持检测：基础聊天、流式输出、系统消息、函数调用、视觉理解、结构化输出
- Web 界面可视化展示检测结果

### 2.4 多渠道管理

```
┌─────────────────────────────────────────────────────────┐
│                     渠道管理系统                         │
├─────────────────────────────────────────────────────────┤
│  自定义 Key: sk-custom-001  →  渠道A (OpenAI)           │
│  自定义 Key: sk-custom-002  →  渠道B (Anthropic)        │
│  自定义 Key: sk-custom-003  →  渠道C (Gemini)           │
├─────────────────────────────────────────────────────────┤
│  • 多渠道负载均衡与故障转移                              │
│  • 模型名称映射配置                                      │
│  • API Key 加密存储                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 第三部分：系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              请求处理流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 客户端   │───▶│ 格式识别 │───▶│ 渠道路由 │───▶│ 请求转换 │             │
│   │ 请求     │    │          │    │          │    │          │             │
│   └──────────┘    └──────────┘    └──────────┘    └────┬─────┘             │
│                                                        │                    │
│        根据路径和Header          根据API Key           转换为目标            │
│        识别源格式               查找目标渠道           API格式               │
│                                                        │                    │
│                                                        ▼                    │
│                                                   ┌──────────┐             │
│                                                   │ 上游 API │             │
│                                                   │ (OpenRouter)           │
│                                                   └────┬─────┘             │
│                                                        │                    │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐        │                    │
│   │ 客户端   │◀───│ 响应转换 │◀───│ 上游响应 │◀───────┘                    │
│   │ 响应     │    │          │    │          │                             │
│   └──────────┘    └──────────┘    └──────────┘                             │
│                                                                             │
│        返回源格式               转换回客户端           接收上游              │
│        响应给客户端             期望的格式             API响应               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心模块

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统模块组成                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         API 层 (入口)                                │   │
│   │  • 接收客户端请求，提供统一的 API 端点                               │   │
│   │  • 根据请求路径分发到对应处理器                                      │   │
│   │  • 支持 OpenAI/Anthropic/Gemini 三种格式的端点                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌───────────────────┐    ┌───────────────────┐    ┌──────────────────┐   │
│   │    格式转换器      │    │    渠道管理器      │    │   能力检测器     │   │
│   ├───────────────────┤    ├───────────────────┤    ├──────────────────┤   │
│   │ • 请求格式转换    │    │ • 渠道配置管理    │    │ • API能力测试    │   │
│   │ • 响应格式转换    │    │ • API Key映射     │    │ • 模型列表获取   │   │
│   │ • 流式chunk转换   │    │ • 模型名称映射    │    │ • 结果可视化     │   │
│   │ • 状态管理        │    │ • 负载均衡        │    │                  │   │
│   └───────────────────┘    └───────────────────┘    └──────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         基础设施层                                   │   │
│   │  • 数据库：存储渠道配置、API Key等                                   │   │
│   │  • HTTP客户端：代理支持、超时控制、重试机制                          │   │
│   │  • 安全模块：API Key加密、会话管理、认证鉴权                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 转换器工厂模式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            转换器工厂架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                        ┌───────────────────┐                                │
│                        │  ConverterFactory │                                │
│                        │    (转换器工厂)    │                                │
│                        └─────────┬─────────┘                                │
│                                  │                                          │
│              ┌───────────────────┼───────────────────┐                      │
│              │                   │                   │                      │
│              ▼                   ▼                   ▼                      │
│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│   │ OpenAIConverter │ │AnthropicConverter│ │ GeminiConverter │              │
│   ├─────────────────┤ ├─────────────────┤ ├─────────────────┤              │
│   │ • 请求转换      │ │ • 请求转换      │ │ • 请求转换      │              │
│   │ • 响应转换      │ │ • 响应转换      │ │ • 响应转换      │              │
│   │ • 流式转换      │ │ • 流式转换      │ │ • 流式转换      │              │
│   └─────────────────┘ └─────────────────┘ └─────────────────┘              │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           转换器核心功能                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. 请求转换：将客户端格式转换为目标API格式                                 │
│      - 消息结构转换（system消息、角色映射）                                  │
│      - 参数名称映射（temperature、max_tokens等）                             │
│      - 工具定义转换（input_schema → parameters）                            │
│                                                                             │
│   2. 响应转换：将上游响应转换回客户端期望格式                                │
│      - 内容结构转换（choices → content blocks）                             │
│      - 工具调用转换（tool_calls → tool_use）                                │
│      - 使用量字段映射（usage统计）                                          │
│                                                                             │
│   3. 流式转换：处理SSE流式响应的实时转换                                     │
│      - 状态机管理（tracking块、text块、tool块）                             │
│      - 事件类型映射（delta → content_block_delta）                          │
│      - 跨chunk状态维护（StreamState）                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 流式状态管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           流式状态管理流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   StreamState（流式状态类）负责管理整个流式响应的状态：                       │
│                                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐                 │
│   │ 未开始  │───▶│ 消息开始 │───▶│ 内容流式 │───▶│ 已完成  │                 │
│   │NOT_START│    │MSG_START│    │STREAMING│    │FINISHED │                 │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘                 │
│                                      │                                      │
│                       ┌──────────────┼──────────────┐                       │
│                       │              │              │                       │
│                       ▼              ▼              ▼                       │
│                 ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│                 │ Thinking │  │   Text   │  │ Tool Use │                   │
│                 │    块    │  │    块    │  │    块    │                   │
│                 └──────────┘  └──────────┘  └──────────┘                   │
│                                                                             │
│   状态追踪内容：                                                             │
│   • 当前消息ID、模型名称                                                     │
│   • 各类型块的索引和是否已开始                                               │
│   • 工具调用的累积参数                                                       │
│   • Token使用量统计                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Gateway 网关模块

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Gateway 网关模块                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Gateway 是一个全局转发端点，提供简化的 API 代理服务：                       │
│   • 端点路径：/gateway/{任意路径}                                           │
│   • 无需配置渠道，全局统一配置一个后端提供商                                 │
│   • 自动检测请求格式，自动转换为目标格式                                     │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Gateway vs 渠道管理                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────┐    ┌─────────────────────────────┐       │
│   │        渠道管理模式          │    │        Gateway 模式          │       │
│   ├─────────────────────────────┤    ├─────────────────────────────┤       │
│   │                             │    │                             │       │
│   │  • 多渠道配置               │    │  • 单一全局配置              │       │
│   │  • 通过 API Key 路由        │    │  • 所有请求统一转发          │       │
│   │  • 支持负载均衡             │    │  • 配置简单快速              │       │
│   │  • 适合复杂场景             │    │  • 适合单一后端场景          │       │
│   │                             │    │                             │       │
│   │  /v1/messages               │    │  /gateway/v1/messages       │       │
│   │  /v1/chat/completions       │    │  /gateway/v1/chat/...       │       │
│   │                             │    │                             │       │
│   └─────────────────────────────┘    └─────────────────────────────┘       │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Gateway 工作流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 客户端   │───▶│ /gateway │───▶│ 格式检测 │───▶│ 格式转换 │             │
│   │ 请求     │    │ 端点     │    │ 自动识别 │    │          │             │
│   └──────────┘    └──────────┘    └──────────┘    └────┬─────┘             │
│                                                        │                    │
│   支持的请求格式：                                      │                    │
│   • Anthropic: /gateway/v1/messages                   │                    │
│   • OpenAI: /gateway/v1/chat/completions              │                    │
│   • Gemini: /gateway/v1beta/models/:generateContent   ▼                    │
│                                                   ┌──────────┐             │
│                                                   │ 全局配置 │             │
│                                                   │ 的后端   │             │
│                                                   │(OpenRouter)            │
│                                                   └────┬─────┘             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐        │                    │
│   │ 客户端   │◀───│ 响应转换 │◀───│ 后端响应 │◀───────┘                    │
│   │ 响应     │    │ 回源格式 │    │          │                             │
│   └──────────┘    └──────────┘    └──────────┘                             │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Gateway 配置项                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   GatewayConfig 配置内容：                                                   │
│                                                                             │
│   • provider      - 后端提供商类型（openai/anthropic/gemini）               │
│   • base_url      - 后端 API 地址（如 https://openrouter.ai/api）           │
│   • timeout       - 请求超时时间（秒）                                       │
│   • max_retries   - 最大重试次数                                            │
│   • model_mapping - 模型名称映射表                                          │
│   • enabled       - 是否启用 Gateway                                        │
│                                                                             │
│   配置存储在数据库 system_config 表中，支持动态更新                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 第四部分：格式转换详解

### 4.1 Anthropic ↔ OpenAI 转换

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Anthropic → OpenAI 请求转换                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        消息结构转换                                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Anthropic                              OpenAI                     │   │
│   │   ─────────                              ──────                     │   │
│   │   system: "你是助手"          ───▶       messages[0]:               │   │
│   │                                            role: "system"           │   │
│   │                                            content: "你是助手"      │   │
│   │                                                                     │   │
│   │   messages:                   ───▶       messages[1...]:            │   │
│   │     role: "user"/"assistant"               role: "user"/"assistant" │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        工具调用转换                                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Anthropic (tool_use)                   OpenAI (tool_calls)        │   │
│   │   ────────────────────                   ──────────────────         │   │
│   │   content: [{                 ───▶       tool_calls: [{             │   │
│   │     type: "tool_use",                      id: "call_xxx",          │   │
│   │     id: "toolu_xxx",                       type: "function",        │   │
│   │     name: "get_weather",                   function: {              │   │
│   │     input: {location:"北京"}                 name: "get_weather",   │   │
│   │   }]                                         arguments: "{...}"     │   │
│   │                                            }                        │   │
│   │                                          }]                         │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        工具结果转换                                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Anthropic (tool_result)                OpenAI (tool message)      │   │
│   │   ───────────────────────                ────────────────────       │   │
│   │   role: "user"                ───▶       role: "tool"               │   │
│   │   content: [{                            tool_call_id: "call_xxx"   │   │
│   │     type: "tool_result",                 content: "晴天，25度"       │   │
│   │     tool_use_id: "toolu_xxx",                                       │   │
│   │     content: "晴天，25度"                                            │   │
│   │   }]                                                                │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 流式事件转换

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      OpenAI SSE → Anthropic SSE 事件转换                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   OpenAI 流式格式                         Anthropic 流式格式                 │
│   ──────────────                          ────────────────                  │
│                                                                             │
│   首个chunk (role)          ───▶          event: message_start             │
│                                           (包含消息元信息)                   │
│                                                                             │
│   delta.content: "你"       ───▶          event: content_block_start       │
│   (首次文本)                              event: content_block_delta        │
│                                           (type: text_delta)               │
│                                                                             │
│   delta.content: "好"       ───▶          event: content_block_delta       │
│   (后续文本)                              (累积输出)                         │
│                                                                             │
│   delta.tool_calls          ───▶          event: content_block_start       │
│   (工具调用开始)                          (type: tool_use)                  │
│                                           event: content_block_delta        │
│                                           (type: input_json_delta)         │
│                                                                             │
│   finish_reason: "stop"     ───▶          event: content_block_stop        │
│   (流结束)                                event: message_delta              │
│                                           event: message_stop               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Gemini ↔ OpenAI 转换

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Gemini → OpenAI 请求转换                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        消息结构转换                                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Gemini                                 OpenAI                     │   │
│   │   ──────                                 ──────                     │   │
│   │   systemInstruction:          ───▶       messages[0]:               │   │
│   │     parts: [{text:"你是助手"}]             role: "system"           │   │
│   │                                            content: "你是助手"      │   │
│   │                                                                     │   │
│   │   contents:                   ───▶       messages[1...]:            │   │
│   │     role: "user"/"model"                   role: "user"/"assistant" │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        工具定义转换                                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Gemini                                 OpenAI                     │   │
│   │   ──────                                 ──────                     │   │
│   │   tools: [{                   ───▶       tools: [{                  │   │
│   │     function_declarations: [{              type: "function",        │   │
│   │       name: "get_weather",                 function: {              │   │
│   │       parameters: {                          name: "get_weather",   │   │
│   │         type: "OBJECT",  ───▶                parameters: {          │   │
│   │         properties: {                          type: "object",      │   │
│   │           city: {type:"STRING"}                properties: {...}    │   │
│   │         }                                    }                      │   │
│   │       }                                    }                        │   │
│   │     }]                                   }]                         │   │
│   │   }]                                     tool_choice: "auto"        │   │
│   │                                                                     │   │
│   │   注意：类型名称 STRING/OBJECT → string/object (大写转小写)          │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     函数调用参数格式转换                             │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   Gemini functionCall                    OpenAI tool_calls          │   │
│   │   ────────────────────                   ──────────────────         │   │
│   │   parts: [{                   ───▶       tool_calls: [{             │   │
│   │     functionCall: {                        id: "call_xxx",          │   │
│   │       name: "get_weather",                 type: "function",        │   │
│   │       args: {                  (对象)      function: {              │   │
│   │         city: "北京"           ───▶          name: "get_weather",   │   │
│   │       }                                      arguments: "{...}"     │   │
│   │     }                          (字符串)    }                        │   │
│   │   }]                                     }]                         │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 工具调用 ID 一致性处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        工具调用 ID 映射机制                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   问题：Gemini 的 functionCall/functionResponse 没有原生 ID 字段            │
│         但 OpenAI 需要 tool_call_id 来关联调用和响应                        │
│                                                                             │
│   解决方案：预扫描对话历史，为每个调用生成一致的 ID 映射                     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         映射生成流程                                 │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   1. 扫描对话历史中的所有 functionCall                               │   │
│   │                     ↓                                               │   │
│   │   2. 按函数名和出现顺序生成唯一 ID                                   │   │
│   │      规则：call_{函数名}_{序号:04d}                                  │   │
│   │                     ↓                                               │   │
│   │   3. 建立映射表：                                                    │   │
│   │      get_weather 第1次调用 → call_get_weather_0001                  │   │
│   │      search 第1次调用      → call_search_0001                       │   │
│   │      get_weather 第2次调用 → call_get_weather_0002                  │   │
│   │                     ↓                                               │   │
│   │   4. functionResponse 通过函数名查找对应的 ID                        │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 多轮工具调用状态保留

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      多轮工具调用状态保留机制                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   使用 OpenRouter 调用 Gemini 推理模型进行多轮工具调用时，                   │
│   需要保留两个关键字段以避免 400 错误：                                      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    1. thoughtSignature 处理                          │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   来源：Gemini 推理模型返回的思考签名（与 functionCall 同级）         │   │
│   │   用途：验证工具调用的推理过程完整性                                 │   │
│   │                                                                     │   │
│   │   处理流程：                                                         │   │
│   │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │   │
│   │   │ Gemini   │───▶│ 捕获并   │───▶│ 转换为   │───▶│ 回填到   │     │   │
│   │   │ 响应     │    │ 缓存签名 │    │ OpenAI   │    │ 下次请求 │     │   │
│   │   └──────────┘    └──────────┘    └──────────┘    └──────────┘     │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    2. reasoning_details 处理                         │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   来源：OpenRouter 返回的推理详情数组                                │   │
│   │   用途：在多轮对话中保持推理上下文                                   │   │
│   │                                                                     │   │
│   │   处理流程：                                                         │   │
│   │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │   │
│   │   │ OpenRouter│───▶│ 缓存到   │───▶│ 下次请求 │───▶│ 附加到   │     │   │
│   │   │ 响应     │    │ 内存     │    │ 时查找   │    │ assistant│     │   │
│   │   └──────────┘    └──────────┘    └──────────┘    └──────────┘     │   │
│   │                                                                     │   │
│   │   缓存机制：                                                         │   │
│   │   • 使用首个 tool_call_id 作为索引                                  │   │
│   │   • TTL 过期（1小时）自动清理                                        │   │
│   │   • LRU 淘汰（超过1000条）防止内存泄漏                               │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 第五部分：思考预算转换

### 5.1 三方思考模式对比

| 提供商 | 参数 | 类型 | 示例值 |
|-------|------|------|-------|
| OpenAI | `reasoning_effort` | 枚举 | `low` / `medium` / `high` |
| Anthropic | `thinking.budget_tokens` | 整数 | `2048`, `8192`, `16384` |
| Gemini | `thinkingConfig.thinkingBudget` | 整数/-1 | `4096`, `-1`(动态) |

### 5.2 转换映射策略

```
┌─────────────────────────────────────────────────────────┐
│                    阈值映射策略                          │
├─────────────────────────────────────────────────────────┤
│  budget_tokens ≤ LOW_THRESHOLD   →  reasoning_effort = "low"     │
│  budget_tokens ≤ HIGH_THRESHOLD  →  reasoning_effort = "medium"  │
│  budget_tokens > HIGH_THRESHOLD  →  reasoning_effort = "high"    │
│  budget_tokens = -1 (动态)       →  reasoning_effort = "high"    │
└─────────────────────────────────────────────────────────┘
```

**环境变量配置**：

```bash
# Anthropic → OpenAI 阈值
ANTHROPIC_TO_OPENAI_LOW_REASONING_THRESHOLD=2048
ANTHROPIC_TO_OPENAI_HIGH_REASONING_THRESHOLD=16384

# Gemini → OpenAI 阈值
GEMINI_TO_OPENAI_LOW_REASONING_THRESHOLD=4096
GEMINI_TO_OPENAI_HIGH_REASONING_THRESHOLD=16384
```

---

## 第六部分：部署与使用

### 6.1 快速开始

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 3. 启动服务
python web_server.py

# 4. 访问 Web 界面
# http://localhost:3000
```

### 6.2 Docker 部署

```bash
# Docker Compose 一键部署
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 6.3 客户端集成示例

**Claude Code 集成**：

```bash
# Mac/Linux
export ANTHROPIC_BASE_URL="https://your-proxy.com"
export ANTHROPIC_API_KEY="sk-your-custom-key"
claude --model claude-sonnet-4

# Windows CMD
set ANTHROPIC_BASE_URL=https://your-proxy.com
set ANTHROPIC_API_KEY=sk-your-custom-key
claude --model claude-sonnet-4
```

**Gemini CLI 集成**：

```bash
# Mac/Linux
export GOOGLE_GEMINI_BASE_URL="https://your-proxy.com"
export GEMINI_API_KEY="your-api-key"
gemini -m gemini-2.5-flash

# Windows CMD
set GOOGLE_GEMINI_BASE_URL=https://your-proxy.com
set GEMINI_API_KEY=your-api-key
gemini -m gemini-2.5-flash
```

### 6.4 主要环境变量配置

| 环境变量 | 说明 | 默认值 |
|---------|------|-------|
| `ADMIN_PASSWORD` | 管理员密码 | `admin123` |
| `DATABASE_TYPE` | 数据库类型 | `sqlite` |
| `LOG_LEVEL` | 日志级别 | `WARNING` |
| `ANTHROPIC_MAX_TOKENS` | Claude 最大 token | `32000` |
| `OPENAI_REASONING_MAX_TOKENS` | 思考模型默认 token | `32000` |

---

## 第七部分：总结与展望

### 7.1 项目价值

```
┌─────────────────────────────────────────────────────────┐
│                      核心价值                            │
├─────────────────────────────────────────────────────────┤
│  ✅ 统一入口：一个代理服务支持三种 API 格式               │
│  ✅ 简化适配：客户端无需关心后端实际提供商                │
│  ✅ 无缝切换：更换提供商只需修改渠道配置                  │
│  ✅ 功能完整：流式、工具调用、视觉、思考模式全支持        │
│  ✅ 生产就绪：完善的错误处理、日志、安全机制              │
└─────────────────────────────────────────────────────────┘
```

### 7.2 适用场景

- **AI 应用开发**：统一 API 接口，降低适配成本
- **多模型对比测试**：快速切换不同提供商进行评估
- **企业内部代理**：统一管理 API Key，控制访问权限
- **降本增效**：根据任务类型路由到不同成本的模型

### 7.3 后续规划

- [ ] 支持更多 AI 提供商 (Mistral, Cohere 等)
- [ ] 请求响应缓存优化
- [ ] 监控面板与用量统计
- [ ] 更丰富的负载均衡策略
- [ ] WebSocket 实时通信支持

---

## 附录：支持的能力矩阵

| 能力 | 描述 | OpenAI | Anthropic | Gemini |
|------|------|:------:|:---------:|:------:|
| 基础聊天 | 基本对话功能 | ✅ | ✅ | ✅ |
| 流式输出 | 实时流式响应 | ✅ | ✅ | ✅ |
| 系统消息 | 系统指令支持 | ✅ | ✅ | ✅ |
| 函数调用 | 工具使用能力 | ✅ | ✅ | ✅ |
| 结构化输出 | JSON 格式输出 | ✅ | ✅ | ✅ |
| 视觉理解 | 图像分析能力 | ✅ | ✅ | ✅ |
| 思考预算 | 智能思考功能 | ✅ | ✅ | ✅ |
| 模型映射 | 名称透明映射 | ✅ | ✅ | ✅ |

---

*文档版本：v1.0*
*最后更新：2025年*
